From 18d63f7e795b728fe8f022f110cf8572e9cce4bd Mon Sep 17 00:00:00 2001
From: Nicolas Raimundo <n.raimundo@phytec.fr>
Date: Thu, 17 Oct 2024 16:07:31 +0200
Subject: [PATCH] Adaptation for KSP-0741

---
 .../dts/freescale/imx93-phyboard-nash.dts     | 74 +++++++++++++++----
 .../boot/dts/freescale/imx93-phycore-som.dtsi | 49 +-----------
 2 files changed, 64 insertions(+), 59 deletions(-)

diff --git a/arch/arm64/boot/dts/freescale/imx93-phyboard-nash.dts b/arch/arm64/boot/dts/freescale/imx93-phyboard-nash.dts
index db9b5367f718..6a6a7d487550 100644
--- a/arch/arm64/boot/dts/freescale/imx93-phyboard-nash.dts
+++ b/arch/arm64/boot/dts/freescale/imx93-phyboard-nash.dts
@@ -25,7 +25,7 @@ chosen {
 
 	reg_can1_stb: regulator-can1-stb {
 		compatible = "regulator-fixed";
-		gpio = <&gpio4 16 GPIO_ACTIVE_LOW>;
+		gpio = <&gpio2 24 GPIO_ACTIVE_LOW>;
 		enable-active-low;
 		pinctrl-names = "default";
 		pinctrl-0 = <&pinctrl_reg_can1_stb>;
@@ -89,19 +89,43 @@ &eqos {
 	status = "okay";
 };
 
-&mdio {
-	ethphy2: ethernet-phy@2 {
-		compatible = "ethernet-phy-ieee802.3-c22";
-		reg = <2>;
-		interrupt-parent = <&gpio3>;
-		interrupts = <26 IRQ_TYPE_EDGE_FALLING>;
-		ti,rx-internal-delay = <DP83867_RGMIIDCTL_1_75_NS>;
-		ti,tx-internal-delay = <DP83867_RGMIIDCTL_2_00_NS>;
-		ti,fifo-depth = <DP83867_PHYCR_FIFO_DEPTH_4_B_NIB>;
-		ti,clk-output-sel = <DP83867_CLK_O_SEL_OFF>;
+&fec {
+	phy-mode = "rgmii-id";
+	phy-handle = <&ethphy1>;
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_fec>;
+	status = "okay";
+
+
+	mdio: mdio {
+		clock-frequency = <5000000>;
+
+		ethphy1: ethernet-phy@1 {
+			compatible = "ethernet-phy-ieee802.3-c22";
+			reg = <0>;
+			interrupt-parent = <&gpio4>;
+			interrupts = <29 IRQ_TYPE_EDGE_FALLING>;
+			ti,rx-internal-delay = <DP83867_RGMIIDCTL_1_75_NS>;
+			ti,tx-internal-delay = <DP83867_RGMIIDCTL_2_00_NS>;
+			ti,fifo-depth = <DP83867_PHYCR_FIFO_DEPTH_4_B_NIB>;
+			ti,clk-output-sel = <DP83867_CLK_O_SEL_OFF>;
+		};
+
+		ethphy2: ethernet-phy@2 {
+			compatible = "ethernet-phy-ieee802.3-c22";
+			reg = <2>;
+			interrupt-parent = <&gpio3>;
+			interrupts = <26 IRQ_TYPE_EDGE_FALLING>;
+			ti,rx-internal-delay = <DP83867_RGMIIDCTL_1_75_NS>;
+			ti,tx-internal-delay = <DP83867_RGMIIDCTL_2_00_NS>;
+			ti,fifo-depth = <DP83867_PHYCR_FIFO_DEPTH_4_B_NIB>;
+			ti,clk-output-sel = <DP83867_CLK_O_SEL_OFF>;
+		};
 	};
 };
 
+
+
 /* CAN */
 &flexcan1 {
 	pinctrl-names = "default";
@@ -125,7 +149,7 @@ i2c_rtc: rtc@52 {
 		pinctrl-names = "default";
 		pinctrl-0 = <&pinctrl_rtc>;
 		interrupt-parent = <&gpio4>;
-		interrupts = <26 IRQ_TYPE_LEVEL_LOW>;
+		interrupts = <28 IRQ_TYPE_LEVEL_LOW>;
 		trickle-resistor-ohms = <3000>;
 		wakeup-source;
 	};
@@ -230,6 +254,28 @@ MX93_PAD_ENET1_TD3__ENET_QOS_RGMII_TD3			0x50e
 			MX93_PAD_ENET1_TXC__CCM_ENET_QOS_CLOCK_GENERATE_TX_CLK	0x58e
 			MX93_PAD_ENET1_TX_CTL__ENET_QOS_RGMII_TX_CTL		0x50e
 			MX93_PAD_CCM_CLKO1__GPIO3_IO26				0x1002
+			// MX93_PAD_ENET1_MDC__ENET_QOS_MDC 0x50e
+			// MX93_PAD_ENET1_MDIO__ENET_QOS_MDIO 0x502
+		>;
+	};
+
+	pinctrl_fec: fecgrp {
+		fsl,pins = <
+			MX93_PAD_ENET2_RD0__ENET1_RGMII_RD0		0x57e
+			MX93_PAD_ENET2_RD1__ENET1_RGMII_RD1		0x57e
+			MX93_PAD_ENET2_RD2__ENET1_RGMII_RD2		0x57e
+			MX93_PAD_ENET2_RD3__ENET1_RGMII_RD3		0x57e
+			MX93_PAD_ENET2_RXC__ENET1_RGMII_RXC   0x5fe
+			MX93_PAD_ENET2_RX_CTL__ENET1_RGMII_RX_CTL	0x57e
+			MX93_PAD_ENET2_TD0__ENET1_RGMII_TD0		0x51e
+			MX93_PAD_ENET2_TD1__ENET1_RGMII_TD1		0x51e
+			MX93_PAD_ENET2_TD2__ENET1_RGMII_TD2		0x50e
+			MX93_PAD_ENET2_TD3__ENET1_RGMII_TD3		0x50e
+			MX93_PAD_ENET2_TXC__ENET1_RGMII_TXC   0x58e
+			MX93_PAD_ENET2_TX_CTL__ENET1_RGMII_TX_CTL	0x58e
+			MX93_PAD_CCM_CLKO4__GPIO4_IO29 0x1002
+			MX93_PAD_ENET2_MDC__ENET1_MDC			0x50e
+			MX93_PAD_ENET2_MDIO__ENET1_MDIO			0x502
 		>;
 	};
 
@@ -258,7 +304,7 @@ MX93_PAD_GPIO_IO03__LPSPI6_SCK		0x3fe
 
 	pinctrl_reg_can1_stb: regcan1stbgrp {
 		fsl,pins = <
-			MX93_PAD_ENET2_TD3__GPIO4_IO16		0x31e
+			MX93_PAD_GPIO_IO24__GPIO2_IO24		0x31e
 		>;
 	};
 
@@ -270,7 +316,7 @@ MX93_PAD_SD2_RESET_B__GPIO3_IO07	0x31e
 
 	pinctrl_rtc: rtcgrp {
 		fsl,pins = <
-			MX93_PAD_ENET2_RD2__GPIO4_IO26		0x31e
+			MX93_PAD_CCM_CLKO3__GPIO4_IO28		0x31e
 		>;
 	};
 
diff --git a/arch/arm64/boot/dts/freescale/imx93-phycore-som.dtsi b/arch/arm64/boot/dts/freescale/imx93-phycore-som.dtsi
index bd052cc876e7..13205029b416 100644
--- a/arch/arm64/boot/dts/freescale/imx93-phycore-som.dtsi
+++ b/arch/arm64/boot/dts/freescale/imx93-phycore-som.dtsi
@@ -57,33 +57,6 @@ &epxp {
 	status = "okay";
 };
 
-/* Ethernet */
-&fec {
-	pinctrl-names = "default";
-	pinctrl-0 = <&pinctrl_fec>;
-	phy-mode = "rmii";
-	phy-handle = <&ethphy1>;
-	assigned-clocks = <&clk IMX93_CLK_ENET_TIMER1>,
-			  <&clk IMX93_CLK_ENET_REF>,
-			  <&clk IMX93_CLK_ENET_REF_PHY>;
-	assigned-clock-parents = <&clk IMX93_CLK_SYS_PLL_PFD1_DIV2>,
-				 <&clk IMX93_CLK_SYS_PLL_PFD1_DIV2>,
-				 <&clk IMX93_CLK_SYS_PLL_PFD1_DIV2>;
-	assigned-clock-rates = <100000000>, <50000000>, <50000000>;
-	status = "okay";
-
-	mdio: mdio {
-		clock-frequency = <5000000>;
-		#address-cells = <1>;
-		#size-cells = <0>;
-
-		ethphy1: ethernet-phy@1 {
-			compatible = "ethernet-phy-id2000.a111", "ethernet-phy-ieee802.3-c22";
-			reg = <1>;
-		};
-	};
-};
-
 /* I2C3 */
 &lpi2c3 {
 	clock-frequency = <400000>;
@@ -98,8 +71,8 @@ pmic@25 {
 		reg = <0x25>;
 		pinctrl-names = "default";
 		pinctrl-0 = <&pinctrl_pmic>;
-		interrupt-parent = <&gpio4>;
-		interrupts = <27 IRQ_TYPE_LEVEL_LOW>;
+		interrupt-parent = <&gpio1>;
+		interrupts = <10 IRQ_TYPE_LEVEL_LOW>;
 
 		regulators {
 			buck1: BUCK1 {
@@ -209,21 +182,6 @@ &wdog3 {
 };
 
 &iomuxc {
-	pinctrl_fec: fecgrp {
-		fsl,pins = <
-			MX93_PAD_ENET2_MDC__ENET1_MDC			0x50e
-			MX93_PAD_ENET2_MDIO__ENET1_MDIO			0x502
-			MX93_PAD_ENET2_RD0__ENET1_RGMII_RD0		0x57e
-			MX93_PAD_ENET2_RD1__ENET1_RGMII_RD1		0x57e
-			MX93_PAD_ENET2_RXC__ENET1_RX_ER			0x5fe
-			MX93_PAD_ENET2_RX_CTL__ENET1_RGMII_RX_CTL	0x57e
-			MX93_PAD_ENET2_TD0__ENET1_RGMII_TD0		0x50e
-			MX93_PAD_ENET2_TD1__ENET1_RGMII_TD1		0x50e
-			MX93_PAD_ENET2_TX_CTL__ENET1_RGMII_TX_CTL	0x50e
-			MX93_PAD_ENET2_TD2__ENET1_TX_CLK		0x4000050e
-		>;
-	};
-
 	pinctrl_leds: ledsgrp {
 		fsl,pins = <
 			MX93_PAD_I2C1_SDA__GPIO1_IO01			0x31e
@@ -239,7 +197,8 @@ MX93_PAD_GPIO_IO29__LPI2C3_SCL			0x40000b9e
 
 	pinctrl_pmic: pmicgrp {
 		fsl,pins = <
-			MX93_PAD_ENET2_RD3__GPIO4_IO27			0x31e
+			//MX93_PAD_ENET2_RD3__GPIO4_IO27			0x31e
+			MX93_PAD_PDM_BIT_STREAM1__GPIO1_IO10 0x31e
 		>;
 	};
 
-- 
2.25.1

