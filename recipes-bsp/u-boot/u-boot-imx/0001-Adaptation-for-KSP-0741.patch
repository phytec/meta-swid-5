From 6ff3e3f7dcb4282b39107bffaa12f5eb656773ed Mon Sep 17 00:00:00 2001
From: Nicolas Raimundo <n.raimundo@phytec.fr>
Date: Mon, 21 Oct 2024 10:57:18 +0200
Subject: [PATCH] Adaptation for KSP-0741

---
 arch/arm/dts/Makefile                        |   3 +-
 arch/arm/dts/imx93-phyboard-nash-u-boot.dtsi | 254 +++++++++++++++++++
 arch/arm/dts/imx93-phyboard-nash.dts         |  70 ++++-
 arch/arm/dts/imx93-phycore-som.dtsi          |  48 +---
 configs/imx93-phycore_defconfig              |   4 +-
 5 files changed, 317 insertions(+), 62 deletions(-)
 create mode 100644 arch/arm/dts/imx93-phyboard-nash-u-boot.dtsi

diff --git a/arch/arm/dts/Makefile b/arch/arm/dts/Makefile
index f5f7165a8c9..e15d99195a9 100644
--- a/arch/arm/dts/Makefile
+++ b/arch/arm/dts/Makefile
@@ -1198,8 +1198,7 @@ dtb-$(CONFIG_ARCH_IMX9) += \
 	imx93-9x9-qsb.dtb \
 	imx93-9x9-qsb-ontat-wvga-panel.dtb \
 	imx93-var-som-symphony.dtb \
-	imx93-phyboard-nash.dtb \
-	imx93-phyboard-segin.dtb
+	imx93-phyboard-nash.dtb
 
 dtb-$(CONFIG_ARCH_IMXRT) += imxrt1050-evk.dtb \
 	imxrt1020-evk.dtb \
diff --git a/arch/arm/dts/imx93-phyboard-nash-u-boot.dtsi b/arch/arm/dts/imx93-phyboard-nash-u-boot.dtsi
new file mode 100644
index 00000000000..0b2e1d3fd5d
--- /dev/null
+++ b/arch/arm/dts/imx93-phyboard-nash-u-boot.dtsi
@@ -0,0 +1,254 @@
+// SPDX-License-Identifier: (GPL-2.0+ OR MIT)
+/*
+ * Copyright (C) 2024 PHYTEC Messtechnik GmbH
+ * Copyright (C) 2023 PHYTEC Messtechnik GmbH
+ * Christoph Stoidner <c.stoidner@phytec.de>
+ *
+ */
+
+#include "imx93-u-boot.dtsi"
+
+/ {
+
+	/*
+	 * If the u-boot build uses the device tree of a phyCORE-i.MX93 carrier
+	 * board (i.E. imx93-phyboard-segin.dts), then this u-boot.dtsi
+	 * deactivates all carrier board-specific peripherals. This means that
+	 * the resulting SPL and u-boot binary can boot the phyCORE-i.MX 93 module
+	 * on each carrier board.
+	 */
+	model = "PHYTEC phyCORE-i.MX93";
+
+	wdt-reboot {
+		compatible = "wdt-reboot";
+		wdt = <&wdog3>;
+		bootph-pre-ram;
+		bootph-some-ram;
+	};
+
+	aliases {
+		ethernet0 = &fec;
+		ethernet1 = &eqos;
+		usbgadget0 = &usbg1;
+	};
+
+	firmware {
+		optee {
+			compatible = "linaro,optee-tz";
+			method = "smc";
+		};
+	};
+
+	usbg1: usbg1 {
+		compatible = "fsl,imx27-usb-gadget";
+		dr_mode = "peripheral";
+		chipidea,usb = <&usbotg1>;
+		status = "okay";
+	};
+};
+
+&{/soc@0} {
+	bootph-all;
+	bootph-pre-ram;
+};
+
+&{/soc@0/bus@42000000/i2c@42530000/pmic@25} {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&{/soc@0/bus@42000000/i2c@42530000/pmic@25/regulators} {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&aips1 {
+	bootph-pre-ram;
+	bootph-all;
+};
+
+&aips2 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&aips3 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&iomuxc {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&eqos {
+	status = "disabled";
+};
+
+&reg_usdhc2_vmmc {
+	u-boot,off-on-delay-us = <20000>;
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&pinctrl_reg_usdhc2_vmmc {
+	bootph-pre-ram;
+};
+
+&pinctrl_uart1 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&pinctrl_usdhc1 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&pinctrl_usdhc2_cd {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&pinctrl_usdhc2_default {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&pinctrl_usdhc2_100mhz {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&pinctrl_usdhc2_200mhz {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&gpio1 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&gpio2 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&gpio3 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&gpio4 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&lpuart1 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&usbmisc1 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&usbphynop1 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&usbotg1 {
+	dr_mode = "peripheral";
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&usdhc1 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&usdhc2 {
+	bootph-pre-ram;
+	bootph-some-ram;
+	fsl,signal-voltage-switch-extra-delay-ms = <8>;
+};
+
+&lpi2c1 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&lpi2c2 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&lpi2c3 {
+	bootph-pre-ram;
+	bootph-some-ram;
+};
+
+&s4muap {
+	bootph-pre-ram;
+	bootph-some-ram;
+	status = "okay";
+};
+
+&clk {
+	bootph-all;
+	bootph-pre-ram;
+	/delete-property/ assigned-clocks;
+	/delete-property/ assigned-clock-rates;
+	/delete-property/ assigned-clock-parents;
+};
+
+&osc_32k {
+	bootph-all;
+	bootph-pre-ram;
+};
+
+&osc_24m {
+	bootph-all;
+	bootph-pre-ram;
+};
+
+&clk_ext1 {
+	bootph-all;
+	bootph-pre-ram;
+};
+
+&wdog3 {
+	bootph-all;
+	bootph-pre-ram;
+};
+
+&iomuxc {
+	pinctrl_lpi2c3: lpi2c3grp {
+		bootph-pre-ram;
+	};
+
+	pinctrl_pmic: pmicgrp {
+		bootph-pre-ram;
+	};
+};
+
+&lpi2c3 {
+	bootph-pre-ram;
+	bootph-some-ram;
+	status = "okay";
+
+	pmic@25 {
+		bootph-pre-ram;
+		bootph-some-ram;
+
+		regulators {
+			bootph-pre-ram;
+			bootph-some-ram;
+		};
+	};
+};
diff --git a/arch/arm/dts/imx93-phyboard-nash.dts b/arch/arm/dts/imx93-phyboard-nash.dts
index 0f84d791ab9..3fc317f6e8d 100644
--- a/arch/arm/dts/imx93-phyboard-nash.dts
+++ b/arch/arm/dts/imx93-phyboard-nash.dts
@@ -25,7 +25,7 @@
 
 	reg_can1_stb: regulator-can1-stb {
 		compatible = "regulator-fixed";
-		gpio = <&gpio4 16 GPIO_ACTIVE_LOW>;
+		gpio = <&gpio2 24 GPIO_ACTIVE_LOW>;
 		enable-active-low;
 		pinctrl-names = "default";
 		pinctrl-0 = <&pinctrl_reg_can1_stb>;
@@ -89,16 +89,38 @@
 	status = "okay";
 };
 
-&mdio {
-	ethphy2: ethernet-phy@2 {
-		compatible = "ethernet-phy-ieee802.3-c22";
-		reg = <2>;
-		interrupt-parent = <&gpio3>;
-		interrupts = <26 IRQ_TYPE_EDGE_FALLING>;
-		ti,rx-internal-delay = <DP83867_RGMIIDCTL_1_75_NS>;
-		ti,tx-internal-delay = <DP83867_RGMIIDCTL_2_00_NS>;
-		ti,fifo-depth = <DP83867_PHYCR_FIFO_DEPTH_4_B_NIB>;
-		ti,clk-output-sel = <DP83867_CLK_O_SEL_OFF>;
+&fec {
+	phy-mode = "rgmii-id";
+	phy-handle = <&ethphy1>;
+	pinctrl-names = "default";
+	pinctrl-0 = <&pinctrl_fec>;
+	status = "okay";
+
+
+	mdio: mdio {
+		clock-frequency = <5000000>;
+
+		ethphy1: ethernet-phy@1 {
+			compatible = "ethernet-phy-ieee802.3-c22";
+			reg = <0>;
+			interrupt-parent = <&gpio4>;
+			interrupts = <29 IRQ_TYPE_EDGE_FALLING>;
+			ti,rx-internal-delay = <DP83867_RGMIIDCTL_1_75_NS>;
+			ti,tx-internal-delay = <DP83867_RGMIIDCTL_2_00_NS>;
+			ti,fifo-depth = <DP83867_PHYCR_FIFO_DEPTH_4_B_NIB>;
+			ti,clk-output-sel = <DP83867_CLK_O_SEL_OFF>;
+		};
+
+		ethphy2: ethernet-phy@2 {
+			compatible = "ethernet-phy-ieee802.3-c22";
+			reg = <2>;
+			interrupt-parent = <&gpio3>;
+			interrupts = <26 IRQ_TYPE_EDGE_FALLING>;
+			ti,rx-internal-delay = <DP83867_RGMIIDCTL_1_75_NS>;
+			ti,tx-internal-delay = <DP83867_RGMIIDCTL_2_00_NS>;
+			ti,fifo-depth = <DP83867_PHYCR_FIFO_DEPTH_4_B_NIB>;
+			ti,clk-output-sel = <DP83867_CLK_O_SEL_OFF>;
+		};
 	};
 };
 
@@ -125,7 +147,7 @@
 		pinctrl-names = "default";
 		pinctrl-0 = <&pinctrl_rtc>;
 		interrupt-parent = <&gpio4>;
-		interrupts = <26 IRQ_TYPE_LEVEL_LOW>;
+		interrupts = <28 IRQ_TYPE_LEVEL_LOW>;
 		trickle-resistor-ohms = <3000>;
 		wakeup-source;
 	};
@@ -231,6 +253,26 @@
 		>;
 	};
 
+	pinctrl_fec: fecgrp {
+		fsl,pins = <
+			MX93_PAD_ENET2_RD0__ENET1_RGMII_RD0		0x57e
+			MX93_PAD_ENET2_RD1__ENET1_RGMII_RD1		0x57e
+			MX93_PAD_ENET2_RD2__ENET1_RGMII_RD2		0x57e
+			MX93_PAD_ENET2_RD3__ENET1_RGMII_RD3		0x57e
+			MX93_PAD_ENET2_RXC__ENET1_RGMII_RXC   0x5fe
+			MX93_PAD_ENET2_RX_CTL__ENET1_RGMII_RX_CTL	0x57e
+			MX93_PAD_ENET2_TD0__ENET1_RGMII_TD0		0x51e
+			MX93_PAD_ENET2_TD1__ENET1_RGMII_TD1		0x51e
+			MX93_PAD_ENET2_TD2__ENET1_RGMII_TD2		0x50e
+			MX93_PAD_ENET2_TD3__ENET1_RGMII_TD3		0x50e
+			MX93_PAD_ENET2_TXC__ENET1_RGMII_TXC   0x58e
+			MX93_PAD_ENET2_TX_CTL__ENET1_RGMII_TX_CTL	0x58e
+			MX93_PAD_CCM_CLKO4__GPIO4_IO29 0x1002
+			MX93_PAD_ENET2_MDC__ENET1_MDC			0x50e
+			MX93_PAD_ENET2_MDIO__ENET1_MDIO			0x502
+		>;
+	};
+
 	pinctrl_flexcan1: flexcan1grp {
 		fsl,pins = <
 			MX93_PAD_PDM_BIT_STREAM0__CAN1_RX	0x139e
@@ -256,7 +298,7 @@
 
 	pinctrl_reg_can1_stb: regcan1stbgrp {
 		fsl,pins = <
-			MX93_PAD_ENET2_TD3__GPIO4_IO16		0x31e
+			MX93_PAD_GPIO_IO24__GPIO2_IO24		0x31e
 		>;
 	};
 
@@ -268,7 +310,7 @@
 
 	pinctrl_rtc: rtcgrp {
 		fsl,pins = <
-			MX93_PAD_ENET2_RD2__GPIO4_IO26		0x31e
+			MX93_PAD_CCM_CLKO3__GPIO4_IO28		0x31e
 		>;
 	};
 
diff --git a/arch/arm/dts/imx93-phycore-som.dtsi b/arch/arm/dts/imx93-phycore-som.dtsi
index bd052cc876e..77d7a730c1d 100644
--- a/arch/arm/dts/imx93-phycore-som.dtsi
+++ b/arch/arm/dts/imx93-phycore-som.dtsi
@@ -57,33 +57,6 @@
 	status = "okay";
 };
 
-/* Ethernet */
-&fec {
-	pinctrl-names = "default";
-	pinctrl-0 = <&pinctrl_fec>;
-	phy-mode = "rmii";
-	phy-handle = <&ethphy1>;
-	assigned-clocks = <&clk IMX93_CLK_ENET_TIMER1>,
-			  <&clk IMX93_CLK_ENET_REF>,
-			  <&clk IMX93_CLK_ENET_REF_PHY>;
-	assigned-clock-parents = <&clk IMX93_CLK_SYS_PLL_PFD1_DIV2>,
-				 <&clk IMX93_CLK_SYS_PLL_PFD1_DIV2>,
-				 <&clk IMX93_CLK_SYS_PLL_PFD1_DIV2>;
-	assigned-clock-rates = <100000000>, <50000000>, <50000000>;
-	status = "okay";
-
-	mdio: mdio {
-		clock-frequency = <5000000>;
-		#address-cells = <1>;
-		#size-cells = <0>;
-
-		ethphy1: ethernet-phy@1 {
-			compatible = "ethernet-phy-id2000.a111", "ethernet-phy-ieee802.3-c22";
-			reg = <1>;
-		};
-	};
-};
-
 /* I2C3 */
 &lpi2c3 {
 	clock-frequency = <400000>;
@@ -98,8 +71,8 @@
 		reg = <0x25>;
 		pinctrl-names = "default";
 		pinctrl-0 = <&pinctrl_pmic>;
-		interrupt-parent = <&gpio4>;
-		interrupts = <27 IRQ_TYPE_LEVEL_LOW>;
+		interrupt-parent = <&gpio1>;
+		interrupts = <10 IRQ_TYPE_LEVEL_LOW>;
 
 		regulators {
 			buck1: BUCK1 {
@@ -209,21 +182,6 @@
 };
 
 &iomuxc {
-	pinctrl_fec: fecgrp {
-		fsl,pins = <
-			MX93_PAD_ENET2_MDC__ENET1_MDC			0x50e
-			MX93_PAD_ENET2_MDIO__ENET1_MDIO			0x502
-			MX93_PAD_ENET2_RD0__ENET1_RGMII_RD0		0x57e
-			MX93_PAD_ENET2_RD1__ENET1_RGMII_RD1		0x57e
-			MX93_PAD_ENET2_RXC__ENET1_RX_ER			0x5fe
-			MX93_PAD_ENET2_RX_CTL__ENET1_RGMII_RX_CTL	0x57e
-			MX93_PAD_ENET2_TD0__ENET1_RGMII_TD0		0x50e
-			MX93_PAD_ENET2_TD1__ENET1_RGMII_TD1		0x50e
-			MX93_PAD_ENET2_TX_CTL__ENET1_RGMII_TX_CTL	0x50e
-			MX93_PAD_ENET2_TD2__ENET1_TX_CLK		0x4000050e
-		>;
-	};
-
 	pinctrl_leds: ledsgrp {
 		fsl,pins = <
 			MX93_PAD_I2C1_SDA__GPIO1_IO01			0x31e
@@ -239,7 +197,7 @@
 
 	pinctrl_pmic: pmicgrp {
 		fsl,pins = <
-			MX93_PAD_ENET2_RD3__GPIO4_IO27			0x31e
+			MX93_PAD_PDM_BIT_STREAM1__GPIO1_IO10			0x31e
 		>;
 	};
 
diff --git a/configs/imx93-phycore_defconfig b/configs/imx93-phycore_defconfig
index 4cd84338989..aaedd7c9f15 100644
--- a/configs/imx93-phycore_defconfig
+++ b/configs/imx93-phycore_defconfig
@@ -11,9 +11,11 @@ CONFIG_ENV_SIZE=0x10000
 CONFIG_ENV_OFFSET=0x700000
 CONFIG_IMX_CONFIG="arch/arm/mach-imx/imx9/imximage.cfg"
 CONFIG_DM_GPIO=y
-CONFIG_DEFAULT_DEVICE_TREE="imx93-phyboard-segin"
+CONFIG_DEFAULT_DEVICE_TREE="imx93-phyboard-nash"
 CONFIG_SPL_TEXT_BASE=0x2049A000
 CONFIG_PHYTEC_SOM_DETECTION=y
+#CONFIG_PHYCORE_IMX93_RAM_TYPE_FIX=y
+#CONFIG_PHYCORE_IMX93_RAM_TYPE_LPDDR4X_1GB=y
 CONFIG_TARGET_PHYCORE_IMX93=y
 CONFIG_OF_LIBFDT_OVERLAY=y
 CONFIG_SYS_MONITOR_LEN=524288
-- 
2.34.1

